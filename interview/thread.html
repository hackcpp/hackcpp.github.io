<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <style>
      :root {
        --c-bg: #fff;
      }

      html.dark {
        --c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.classList.toggle('dark', true)
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/images/favicon.ico"><title>程序员白粥馆</title><meta name="description" content="贴心的编程学习路线，全面的编程知识百科">
    <link rel="preload" href="/assets/style-CM8lyNpb.css" as="style"><link rel="stylesheet" href="/assets/style-CM8lyNpb.css">
    <link rel="modulepreload" href="/assets/app-BDBff7B5.js"><link rel="modulepreload" href="/assets/thread.html-dc35Jovl.js">
    <link rel="prefetch" href="/assets/index.html-DDqAtqaB.js" as="script"><link rel="prefetch" href="/assets/个人简历-C__ 开发.html-CVJ0gPfl.js" as="script"><link rel="prefetch" href="/assets/array.html-C5kpGANh.js" as="script"><link rel="prefetch" href="/assets/c__basic.html-CHBLL3UE.js" as="script"><link rel="prefetch" href="/assets/design_patterns.html-Dr5KLj7y.js" as="script"><link rel="prefetch" href="/assets/process.html-BCwvUZcb.js" as="script"><link rel="prefetch" href="/assets/404.html-BIkbG38j.js" as="script"><link rel="prefetch" href="/assets/SearchResult-Bzy3IUqm.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon"><!--[--><header class="vp-navbar"><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/images/hero.png" alt="程序员白粥馆"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">程序员白粥馆</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="首页"><!---->首页<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据结构"><span class="title">数据结构</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据结构"><span class="title">数据结构</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/algo/array.html" aria-label="数组与链表"><!---->数组与链表<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="面试集锦"><span class="title">面试集锦</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="面试集锦"><span class="title">面试集锦</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/interview/c__basic.html" aria-label="c++ 基础"><!---->c++ 基础<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/interview/thread.html" aria-label="线程编程"><!---->线程编程<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/interview/process.html" aria-label="进程编程"><!---->进程编程<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/interview/design_patterns.html" aria-label="设计模式"><!---->设计模式<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/lucas-hliu/lucas-hliu.github.io" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><button class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar"><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="首页"><!---->首页<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据结构"><span class="title">数据结构</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据结构"><span class="title">数据结构</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/algo/array.html" aria-label="数组与链表"><!---->数组与链表<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="面试集锦"><span class="title">面试集锦</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="面试集锦"><span class="title">面试集锦</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/interview/c__basic.html" aria-label="c++ 基础"><!---->c++ 基础<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/interview/thread.html" aria-label="线程编程"><!---->线程编程<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/interview/process.html" aria-label="进程编程"><!---->进程编程<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/interview/design_patterns.html" aria-label="设计模式"><!---->设计模式<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/lucas-hliu/lucas-hliu.github.io" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading"> <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h2 id="线程创建" tabindex="-1"><a class="header-anchor" href="#线程创建"><span>线程创建</span></a></h2><div class="language-text line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-text;"><code><span class="line"><span class="line"><span>// thread example</span></span></span>
<span class="line"><span class="line"><span>#include &lt;iostream&gt;       // std::cout</span></span></span>
<span class="line"><span class="line"><span>#include &lt;thread&gt;         // std::thread</span></span></span>
<span class="line"><span class="line"><span> </span></span></span>
<span class="line"><span class="line"><span>void foo() </span></span></span>
<span class="line"><span class="line"><span>{</span></span></span>
<span class="line"><span class="line"><span>  // do stuff...</span></span></span>
<span class="line"><span class="line"><span>}</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>void bar(int x)</span></span></span>
<span class="line"><span class="line"><span>{</span></span></span>
<span class="line"><span class="line"><span>  // do stuff...</span></span></span>
<span class="line"><span class="line"><span>}</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>int main() </span></span></span>
<span class="line"><span class="line"><span>{</span></span></span>
<span class="line"><span class="line"><span>  std::thread first (foo);     // spawn new thread that calls foo()</span></span></span>
<span class="line"><span class="line"><span>  std::thread second (bar,0);  // spawn new thread that calls bar(0)</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>  std::cout &lt;&lt; &quot;main, foo and bar now execute concurrently...\n&quot;;</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>  // synchronize threads:</span></span></span>
<span class="line"><span class="line"><span>  first.join();                // pauses until first finishes</span></span></span>
<span class="line"><span class="line"><span>  second.join();               // pauses until second finishes</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>  std::cout &lt;&lt; &quot;foo and bar completed.\n&quot;;</span></span></span>
<span class="line"><span class="line"><span></span></span></span>
<span class="line"><span class="line"><span>  return 0;</span></span></span>
<span class="line"><span class="line"><span>}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="线程同步机制" tabindex="-1"><a class="header-anchor" href="#线程同步机制"><span>线程同步机制</span></a></h2><h3 id="_1-互斥量-mutex" tabindex="-1"><a class="header-anchor" href="#_1-互斥量-mutex"><span>1. 互斥量 (Mutex)</span></a></h3><p><strong>实现原理</strong>：</p><p>互斥量的核心原理是通过锁定和解锁机制来控制对共享资源的访问。具体实现步骤如下：</p><ol><li><p><strong>基本结构</strong>：</p><ul><li>互斥量有一个内部状态，通常用布尔值或整数表示（锁定或未锁定）。</li><li>维护一个等待队列，用于保存等待锁的线程。</li></ul></li><li><p><strong>锁定 (Lock)</strong>：</p><ul><li>当一个线程尝试锁定互斥量时，如果互斥量未锁定，则线程成功锁定，并将互斥量状态设置为锁定。</li><li>如果互斥量已锁定，则该线程进入等待队列并挂起，直到互斥量被解锁。</li></ul></li><li><p><strong>解锁 (Unlock)</strong>：</p><ul><li>当一个线程解锁互斥量时，如果等待队列中有其他线程，则唤醒一个线程，使其尝试重新锁定互斥量。</li><li>如果没有线程在等待，则将互斥量状态设置为未锁定。</li></ul></li></ol><p><strong>代码示例</strong>：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">mutex</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">mutex mtx</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> print_thread_id</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> id</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">lock_guard</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">mutex</span><span style="color:#81A1C1;">&gt;</span><span style="color:#88C0D0;"> guard</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">mtx</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 自动加锁和解锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Thread #</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> id </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#D8DEE9;">threads</span><span style="color:#ECEFF4;">[</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        threads</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">thread</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">print_thread_id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">auto&amp;</span><span style="color:#D8DEE9FF;"> th </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        th</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-读写锁-shared-mutex" tabindex="-1"><a class="header-anchor" href="#_2-读写锁-shared-mutex"><span>2. 读写锁 (Shared Mutex)</span></a></h3><p><strong>实现原理</strong>：</p><p>读写锁允许多个线程同时读取，但在写入时只允许一个线程操作。其实现原理如下：</p><ol><li><p><strong>基本结构</strong>：</p><ul><li>读写锁包含两个计数器：一个用于记录当前正在读取的线程数，另一个用于记录是否有写线程在等待。</li><li>维护一个等待队列，用于保存等待的线程。</li></ul></li><li><p><strong>读锁定 (Read Lock)</strong>：</p><ul><li>当一个线程请求读锁定时，如果没有写锁存在，则增加读计数器，线程继续执行。</li><li>如果有写锁存在，则线程进入等待队列。</li></ul></li><li><p><strong>写锁定 (Write Lock)</strong>：</p><ul><li>当一个线程请求写锁定时，如果没有读锁和写锁存在，则锁定成功。</li><li>如果有读锁或写锁存在，则线程进入等待队列。</li></ul></li><li><p><strong>解锁 (Unlock)</strong>：</p><ul><li>当读线程解锁时，减少读计数器，如果读计数器为0且有写线程在等待，则唤醒一个写线程。</li><li>当写线程解锁时，如果有读线程在等待，则唤醒所有读线程；如果有写线程在等待，则唤醒一个写线程。</li></ul></li></ol><p><strong>代码示例</strong>：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">shared_mutex</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">vector</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">shared_mutex rw_mtx</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">vector</span><span style="color:#81A1C1;">&lt;int&gt;</span><span style="color:#D8DEE9FF;"> data</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> reader</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">shared_lock</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">shared_mutex</span><span style="color:#81A1C1;">&gt;</span><span style="color:#88C0D0;"> lock</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">rw_mtx</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#81A1C1;"> auto&amp;</span><span style="color:#D8DEE9FF;"> d </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> data</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">        std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> d </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> writer</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">unique_lock</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">shared_mutex</span><span style="color:#81A1C1;">&gt;</span><span style="color:#88C0D0;"> lock</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">rw_mtx</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    data</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">push_back</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">value</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">t1</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">writer</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">t2</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">reader</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">t3</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">writer</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">t4</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">reader</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    t1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    t2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    t3</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    t4</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-条件变量-condition-variable" tabindex="-1"><a class="header-anchor" href="#_3-条件变量-condition-variable"><span>3. 条件变量 (Condition Variable)</span></a></h3><p><strong>实现原理</strong>：</p><p>条件变量用于线程之间的等待和通知机制。其实现原理如下：</p><ol><li><p><strong>基本结构</strong>：</p><ul><li>条件变量与一个互斥量和一个条件状态相关联。</li><li>维护一个等待队列，用于保存等待条件的线程。</li></ul></li><li><p><strong>等待 (Wait)</strong>：</p><ul><li>线程在等待条件变量时，需要持有相关的互斥量。</li><li>线程将自己添加到等待队列，并释放互斥量，等待条件变量的通知。</li></ul></li><li><p><strong>通知 (Notify)</strong>：</p><ul><li>当一个线程修改条件状态并调用 <code>notify_one</code> 或 <code>notify_all</code> 时，唤醒一个或所有等待队列中的线程。</li><li>被唤醒的线程重新获得互斥量，检查条件状态，如果条件满足，线程继续执行；如果条件不满足，线程再次进入等待状态。</li></ul></li></ol><p><strong>代码示例</strong>：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">mutex</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">condition_variable</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">mutex cv_mtx</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">condition_variable cv</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">bool</span><span style="color:#D8DEE9FF;"> ready </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> print_id</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> id</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">unique_lock</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">mutex</span><span style="color:#81A1C1;">&gt;</span><span style="color:#88C0D0;"> lock</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">cv_mtx</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    cv</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">wait</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">lock</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> []</span><span style="color:#ECEFF4;"> {</span><span style="color:#81A1C1;"> return</span><span style="color:#D8DEE9FF;"> ready</span><span style="color:#81A1C1;">;</span><span style="color:#ECEFF4;"> })</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 等待 ready 变为 true</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Thread #</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> id </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> set_ready</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">this_thread</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">sleep_for</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">chrono</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">seconds</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">        std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">lock_guard</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">mutex</span><span style="color:#81A1C1;">&gt;</span><span style="color:#88C0D0;"> lock</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">cv_mtx</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">        ready </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    cv</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">notify_all</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 唤醒所有等待的线程</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#D8DEE9;">threads</span><span style="color:#ECEFF4;">[</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        threads</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">thread</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">print_id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">t</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">set_ready</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">auto&amp;</span><span style="color:#D8DEE9FF;"> th </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        th</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    t</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用场景</strong>：</p><ul><li>条件变量常用于线程之间的协调，例如在生产者-消费者模型中，生产者线程通知消费者线程有新数据可用，消费者线程等待该通知。</li></ul><h3 id="_4-原子操作-atomic-operations" tabindex="-1"><a class="header-anchor" href="#_4-原子操作-atomic-operations"><span>4. 原子操作 (Atomic Operations)</span></a></h3><p><strong>实现原理</strong>：</p><p>原子操作通过硬件支持的指令集实现，保证在并发环境下操作的不可分割性。其实现原理如下：</p><ol><li><p><strong>硬件支持</strong>：</p><ul><li>原子操作依赖于硬件提供的原子指令，如 <code>compare-and-swap</code> (CAS)、<code>fetch-and-add</code> 等，这些指令能够确保在多个线程操作同一数据时不会产生竞争条件。</li></ul></li><li><p><strong>内存模型</strong>：</p><ul><li>C++ 中的 <code>std::atomic</code> 提供了对不同内存模型的支持，确保在不同平台上实现一致的原子操作行为。</li></ul></li><li><p><strong>无需锁定</strong>：</p><ul><li>原子操作直接操作共享变量，不需要加锁解锁，因此在高并发场景下具有更好的性能。</li></ul></li></ol><p><strong>代码示例</strong>：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">atomic</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">atomic</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">int</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#88C0D0;"> counter</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> increment</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 1000</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        ++</span><span style="color:#D8DEE9FF;">counter</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 原子操作</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#D8DEE9;">threads</span><span style="color:#ECEFF4;">[</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        threads</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">thread</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">increment</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">auto&amp;</span><span style="color:#D8DEE9FF;"> th </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        th</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Final counter value: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> counter </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用场景</strong>：</p><ul><li>原子操作适用于需要高效并发访问的场景，如计数器、标志位等，避免使用锁机制带来的开销。</li></ul><h3 id="_5-信号量-semaphore" tabindex="-1"><a class="header-anchor" href="#_5-信号量-semaphore"><span>5. 信号量 (Semaphore)</span></a></h3><p><strong>实现原理</strong>：</p><p>信号量是一种控制对共享资源访问的计数器，分为计数信号量和二进制信号量。其实现原理如下：</p><ol><li><p><strong>计数器</strong>：</p><ul><li>信号量内部维护一个计数器，表示当前可用资源的数量。计数器初始值通常为资源的总量。</li></ul></li><li><p><strong>P 操作 (等待操作)</strong>：</p><ul><li>当一个线程执行 P 操作（<code>wait</code> 或 <code>acquire</code>）时，计数器减 1。如果计数器值为正，线程继续执行；如果计数器值为零或负，线程进入等待队列，等待资源释放。</li></ul></li><li><p><strong>V 操作 (释放操作)</strong>：</p><ul><li>当一个线程执行 V 操作（<code>signal</code> 或 <code>release</code>）时，计数器加 1。如果有线程在等待队列中，唤醒一个线程，使其继续执行。</li></ul></li></ol><p><strong>代码示例</strong>：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">semaphore</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">counting_semaphore</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#88C0D0;"> sem</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> worker</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> id</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    sem</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">acquire</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // P 操作</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Thread #</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> id </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> is working</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">this_thread</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">sleep_for</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">chrono</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">seconds</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    sem</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">release</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // V 操作</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#D8DEE9;">threads</span><span style="color:#ECEFF4;">[</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        threads</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">thread</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">worker</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">auto&amp;</span><span style="color:#D8DEE9FF;"> th </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        th</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用场景</strong>：</p><ul><li>信号量适用于控制对资源的并发访问数量，例如限制同时访问文件的线程数、实现生产者-消费者模型等。</li></ul><h3 id="_6-自旋锁-spinlock" tabindex="-1"><a class="header-anchor" href="#_6-自旋锁-spinlock"><span>6. 自旋锁 (Spinlock)</span></a></h3><p><strong>实现原理</strong>：</p><p>自旋锁是一种忙等待锁，线程在尝试获取锁时会反复检查锁的状态，而不会阻塞或挂起。其实现原理如下：</p><ol><li><p><strong>忙等待</strong>：</p><ul><li>当一个线程尝试获取自旋锁时，如果锁已经被其他线程持有，线程将反复检查锁的状态，直到锁可用为止。</li><li>自旋锁通常通过硬件的原子操作实现，如 <code>test-and-set</code>、<code>compare-and-swap</code> 等。</li></ul></li><li><p><strong>解锁</strong>：</p><ul><li>当持有锁的线程释放自旋锁时，其他线程可以成功获取锁并继续执行。</li></ul></li></ol><p><strong>代码示例</strong>：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">atomic</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> Spinlock</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">atomic_flag flag </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> ATOMIC_FLAG_INIT</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    void</span><span style="color:#88C0D0;"> lock</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        while</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">flag</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">test_and_set</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_acquire</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 自旋等待</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    void</span><span style="color:#88C0D0;"> unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        flag</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">clear</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_release</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">Spinlock spinlock</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> worker</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> id</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    spinlock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">lock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Thread #</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> id </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> is working</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">this_thread</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">sleep_for</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">chrono</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">seconds</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    spinlock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#D8DEE9;">threads</span><span style="color:#ECEFF4;">[</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        threads</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#88C0D0;">thread</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">worker</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">auto&amp;</span><span style="color:#D8DEE9FF;"> th </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        th</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用场景</strong>：</p><ul><li>自旋锁适用于锁定时间非常短的场景，例如在中断上下文或需要避免线程调度开销的情况下使用。</li></ul><h3 id="_7-屏障-barrier" tabindex="-1"><a class="header-anchor" href="#_7-屏障-barrier"><span>7. 屏障 (Barrier)</span></a></h3><p><strong>实现原理</strong>：</p><p>屏障用于同步一组线程，确保所有线程都到达某个同步点后才能继续执行。其实现原理如下：</p><ol><li><p><strong>计数器</strong>：</p><ul><li>屏障内部维护一个计数器，表示已到达屏障的线程数量。每当一个线程到达屏障点时，计数器减 1。</li></ul></li><li><p><strong>等待机制</strong>：</p><ul><li>当计数器达到零时，表示所有线程都已到达屏障点，屏障解除，所有等待的线程继续执行。</li></ul></li></ol><p><strong>代码示例</strong>：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">barrier</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">vector</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">barrier </span><span style="color:#88C0D0;">sync_point</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> worker</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> id</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Thread #</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> id </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> is waiting</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    sync_point</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">arrive_and_wait</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 等待所有线程到达屏障点</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Thread #</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> id </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> is proceeding</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">vector</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        threads</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">emplace_back</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">worker</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">auto&amp;</span><span style="color:#D8DEE9FF;"> th </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        th</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用场景</strong>：</p><ul><li>屏障适用于并行计算中需要同步多个线程的场景，例如在每个计算步骤完成后同步所有线程。</li></ul><h3 id="_8-锁存器-latch" tabindex="-1"><a class="header-anchor" href="#_8-锁存器-latch"><span>8. 锁存器 (Latch)</span></a></h3><p><strong>实现原理</strong>：</p><p>锁存器类似于屏障，但只能使用一次，线程等待直到锁存器倒数到零。其实现原理如下：</p><ol><li><p><strong>倒数计数器</strong>：</p><ul><li>锁存器内部维护一个倒数计数器，表示需要完成的任务数量。每次完成任务时，计数器减 1。</li></ul></li><li><p><strong>等待机制</strong>：</p><ul><li>当计数器减为零时，所有等待的线程被唤醒，继续执行。</li></ul></li></ol><p><strong>代码示例</strong>：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">latch</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">vector</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">latch </span><span style="color:#88C0D0;">sync_point</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> worker</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> id</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Thread #</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> id </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> has reached the latch point</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    sync_point</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">count_down</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 锁存器计数减少</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    sync_point</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">wait</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 等待所有线程到达锁存器</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Thread #</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> id </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> is proceeding</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">vector</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        threads</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">emplace_back</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">worker</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">auto&amp;</span><span style="color:#D8DEE9FF;"> th </span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> threads</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        th</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用场景</strong>：</p><ul><li>锁存器适用于需要等待一组线程或任务完成后才能继续执行的场景，例如初始化任务完成后启动主任务。</li></ul><h2 id="无锁编程" tabindex="-1"><a class="header-anchor" href="#无锁编程"><span>无锁编程</span></a></h2><p>无锁编程（Lock-Free Programming）是一种在多线程环境中实现并发访问的技术，目的是避免传统锁机制（如互斥锁）带来的性能开销和死锁风险。无锁编程主要依赖于原子操作和内存序列模型，以确保在没有锁的情况下实现线程安全。</p><h3 id="_1-基本概念" tabindex="-1"><a class="header-anchor" href="#_1-基本概念"><span>1. 基本概念</span></a></h3><ul><li><strong>原子操作</strong>：原子操作是不可分割的，多个线程对同一变量进行原子操作时，不会引起数据竞争。</li><li><strong>CAS (Compare-and-Swap)</strong>：这是无锁编程的核心操作之一，它检查一个变量是否有特定的值，如果是，则将其更改为新值。这个操作是原子的，即在执行时不会被其他线程打断。</li><li><strong>内存序列模型</strong>：C++ 提供了一组内存序列模型（如 <code>memory_order_relaxed</code>、<code>memory_order_acquire</code>、<code>memory_order_release</code> 等），以控制并发操作的顺序性。</li></ul><h3 id="_2-c-中的原子操作" tabindex="-1"><a class="header-anchor" href="#_2-c-中的原子操作"><span>2. C++ 中的原子操作</span></a></h3><p>C++11 引入了 <code>std::atomic</code> 模板类，为实现无锁编程提供了基础设施。它支持以下操作：</p><ul><li>原子加载和存储</li><li>原子递增和递减</li><li>原子交换</li><li>原子比较并交换（CAS）</li></ul><h3 id="_3-使用原子变量实现无锁队列" tabindex="-1"><a class="header-anchor" href="#_3-使用原子变量实现无锁队列"><span>3. 使用原子变量实现无锁队列</span></a></h3><p>下面是一个简单的无锁单生产者单消费者队列的实现示例：</p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">atomic</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">iostream</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">thread</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#5E81AC;font-weight:bold;">#</span><span style="color:#81A1C1;">include</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#A3BE8C;">vector</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">template</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#81A1C1;">typename</span><span style="color:#D8DEE9FF;"> T</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> LockFreeQueue</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">    LockFreeQueue</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">size_t</span><span style="color:#D8DEE9;"> capacity</span><span style="color:#ECEFF4;">)</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        :</span><span style="color:#88C0D0;"> capacity</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">capacity</span><span style="color:#ECEFF4;">),</span><span style="color:#88C0D0;"> head</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">),</span><span style="color:#88C0D0;"> tail</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">        buffer </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9;"> T</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">capacity</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">    ~LockFreeQueue</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        delete[]</span><span style="color:#D8DEE9FF;"> buffer</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    bool</span><span style="color:#88C0D0;"> enqueue</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> T</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9;"> item</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        size_t</span><span style="color:#D8DEE9FF;"> currentTail </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> tail</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_relaxed</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        size_t</span><span style="color:#D8DEE9FF;"> nextTail </span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">currentTail </span><span style="color:#81A1C1;">+</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> %</span><span style="color:#D8DEE9FF;"> capacity</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">nextTail </span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9;"> head</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_acquire</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#81A1C1;"> false;</span><span style="color:#616E88;"> // 队列已满</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        buffer</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">currentTail</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> item</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        tail</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">store</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">nextTail</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_release</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    bool</span><span style="color:#88C0D0;"> dequeue</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">T</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9;"> item</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        size_t</span><span style="color:#D8DEE9FF;"> currentHead </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> head</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_relaxed</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">currentHead </span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9;"> tail</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_acquire</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#81A1C1;"> false;</span><span style="color:#616E88;"> // 队列为空</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">        item </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">currentHead</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        // 使用 memory_order_release 确保更新操作一定在取值之后 </span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        head</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">store</span><span style="color:#ECEFF4;">((</span><span style="color:#D8DEE9FF;">currentHead </span><span style="color:#81A1C1;">+</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> %</span><span style="color:#D8DEE9FF;"> capacity</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_release</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">private</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    T</span><span style="color:#81A1C1;">*</span><span style="color:#D8DEE9FF;"> buffer</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    size_t</span><span style="color:#D8DEE9FF;"> capacity</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">atomic</span><span style="color:#81A1C1;">&lt;size_t&gt;</span><span style="color:#D8DEE9FF;"> head</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">atomic</span><span style="color:#81A1C1;">&lt;size_t&gt;</span><span style="color:#D8DEE9FF;"> tail</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    LockFreeQueue</span><span style="color:#81A1C1;">&lt;int&gt;</span><span style="color:#88C0D0;"> queue</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    // 启动生产者线程</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">producer</span><span style="color:#ECEFF4;">([</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">]()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            while</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                // 如果队列已满，等待</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">            std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Produced: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    })</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    // 启动消费者线程</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">consumer</span><span style="color:#ECEFF4;">([</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">]()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            int</span><span style="color:#D8DEE9FF;"> item</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            while</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">dequeue</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">item</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                // 如果队列为空，等待</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">            std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Consumed: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> item </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    })</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    producer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    consumer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-代码结构和作用" tabindex="-1"><a class="header-anchor" href="#_4-代码结构和作用"><span>4. 代码结构和作用</span></a></h3><ul><li><p><strong>类定义与构造函数</strong></p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">template</span><span style="color:#ECEFF4;"> &lt;</span><span style="color:#81A1C1;">typename</span><span style="color:#D8DEE9FF;"> T</span><span style="color:#ECEFF4;">&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> LockFreeQueue</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">    LockFreeQueue</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">size_t</span><span style="color:#D8DEE9;"> capacity</span><span style="color:#ECEFF4;">)</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        :</span><span style="color:#88C0D0;"> capacity</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">capacity</span><span style="color:#ECEFF4;">),</span><span style="color:#88C0D0;"> head</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">),</span><span style="color:#88C0D0;"> tail</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">        buffer </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9;"> T</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">capacity</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">    ~LockFreeQueue</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        delete[]</span><span style="color:#D8DEE9FF;"> buffer</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>LockFreeQueue</code> 类是一个泛型队列，使用模板参数 <code>T</code> 来定义队列元素的类型。</li><li>构造函数初始化队列的容量 <code>capacity</code>，并将 <code>head</code> 和 <code>tail</code> 指针初始化为 0。</li><li>队列使用一个动态分配的数组 <code>buffer</code> 来存储元素。</li></ul></li><li><p><strong><code>enqueue</code> 方法</strong></p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">bool</span><span style="color:#88C0D0;"> enqueue</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> T</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9;"> item</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    size_t</span><span style="color:#D8DEE9FF;"> currentTail </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> tail</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_relaxed</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    size_t</span><span style="color:#D8DEE9FF;"> nextTail </span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">currentTail </span><span style="color:#81A1C1;">+</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> %</span><span style="color:#D8DEE9FF;"> capacity</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">nextTail </span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9;"> head</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_acquire</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> false;</span><span style="color:#616E88;"> // 队列已满</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    buffer</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">currentTail</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> item</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    tail</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">store</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">nextTail</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_release</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>enqueue</code> 方法用于将一个元素插入队列。</li><li><code>tail.load(std::memory_order_relaxed)</code>：原子地加载当前的尾部指针 <code>tail</code> 的值。使用 <code>memory_order_relaxed</code> 是因为我们不需要同步其他内存操作，仅仅读取尾部的值。</li><li><code>nextTail = (currentTail + 1) % capacity</code>：计算插入元素后的尾部指针值，使用取模操作来实现循环队列。</li><li><code>if (nextTail == head.load(std::memory_order_acquire))</code>：检查队列是否已满。如果 <code>nextTail</code> 与头部指针 <code>head</code> 相等，说明队列已满。</li><li><code>buffer[currentTail] = item</code>：将元素存储在当前尾部指针所指向的位置。</li><li><code>tail.store(nextTail, std::memory_order_release)</code>：将新的尾部指针存储到 <code>tail</code>，并使用 <code>memory_order_release</code> 以确保插入操作完成后，其他线程能正确地看到更新的尾部指针。</li></ul></li><li><p><strong><code>dequeue</code> 方法</strong></p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">bool</span><span style="color:#88C0D0;"> dequeue</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">T</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9;"> item</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    size_t</span><span style="color:#D8DEE9FF;"> currentHead </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> head</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_relaxed</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">currentHead </span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9;"> tail</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_acquire</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> false;</span><span style="color:#616E88;"> // 队列为空</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    item </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">currentHead</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    head</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">store</span><span style="color:#ECEFF4;">((</span><span style="color:#D8DEE9FF;">currentHead </span><span style="color:#81A1C1;">+</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> %</span><span style="color:#D8DEE9FF;"> capacity</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">memory_order_release</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>dequeue</code> 方法用于从队列中取出一个元素。</li><li><code>currentHead = head.load(std::memory_order_relaxed)</code>：原子地加载当前的头部指针 <code>head</code> 的值。</li><li><code>if (currentHead == tail.load(std::memory_order_acquire))</code>：检查队列是否为空。如果 <code>head</code> 与 <code>tail</code> 相等，说明队列为空。</li><li><code>item = buffer[currentHead]</code>：将头部指针所指向的元素存储到 <code>item</code> 中。</li><li><code>head.store((currentHead + 1) % capacity, std::memory_order_release)</code>：更新头部指针，指向下一个元素的位置，并使用 <code>memory_order_release</code> 以确保取出操作完成后，其他线程能正确地看到更新的头部指针。</li></ul></li><li><p><strong>主函数中的生产者和消费者</strong></p><div class="language-cpp line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-cpp;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    LockFreeQueue</span><span style="color:#81A1C1;">&lt;int&gt;</span><span style="color:#88C0D0;"> queue</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    // 启动生产者线程</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">producer</span><span style="color:#ECEFF4;">([</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">]()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            while</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                // 如果队列已满，等待</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">            std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Produced: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    })</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    // 启动消费者线程</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">thread </span><span style="color:#88C0D0;">consumer</span><span style="color:#ECEFF4;">([</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">]()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            int</span><span style="color:#D8DEE9FF;"> item</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            while</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">dequeue</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">item</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                // 如果队列为空，等待</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">            std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">cout </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Consumed: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> &lt;&lt;</span><span style="color:#D8DEE9FF;"> item </span><span style="color:#81A1C1;">&lt;&lt;</span><span style="color:#D8DEE9FF;"> std</span><span style="color:#ECEFF4;">::</span><span style="color:#D8DEE9FF;">endl</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    })</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    producer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    consumer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在 <code>main</code> 函数中，创建了一个 <code>LockFreeQueue</code> 对象 <code>queue</code>，容量为 10。</li><li>生产者线程 <code>producer</code> 向队列中插入元素，使用 <code>while (!queue.enqueue(i))</code> 检查插入操作是否成功。如果队列已满，线程会持续等待直到成功插入。</li><li>消费者线程 <code>consumer</code> 从队列中取出元素，使用 <code>while (!queue.dequeue(item))</code> 检查取出操作是否成功。如果队列为空，线程会持续等待直到成功取出元素。</li><li>两个线程同时运行，生产者插入数据，消费者取出数据，并输出相应的信息。</li><li>最后，通过 <code>join()</code> 等待线程完成，确保主线程在两个子线程结束后才退出。</li></ul></li></ul><h3 id="_5-内存顺序的选择" tabindex="-1"><a class="header-anchor" href="#_5-内存顺序的选择"><span>5. 内存顺序的选择</span></a></h3><ul><li><strong><code>memory_order_relaxed</code></strong>：用于没有数据依赖的地方，只要求操作是原子的，不需要同步内存顺序。适用于 <code>load</code> 和 <code>store</code>，如 <code>tail.load(std::memory_order_relaxed)</code>。</li><li><strong><code>memory_order_acquire</code></strong>：用于加载操作，以确保加载的结果及其后续的操作不会被重排序到 <code>acquire</code> 之前。适用于检查队列是否满或空，如 <code>head.load(std::memory_order_acquire)</code>。</li><li><strong><code>memory_order_release</code></strong>：用于存储操作，以确保在此之前的所有操作不会被重排序到 <code>release</code> 之后。适用于更新指针操作，如 <code>tail.store(nextTail, std::memory_order_release)</code>。</li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: liuheng2015@gmail.com">liuheng</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BDBff7B5.js" defer></script>
  </body>
</html>
